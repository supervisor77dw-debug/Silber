// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// COMEX Warehouse Stocks (Daily Snapshot)
model ComexStock {
  id               String   @id @default(cuid())
  date             DateTime @unique
  
  // Aggregated values
  totalRegistered  Float
  totalEligible    Float
  totalCombined    Float
  
  // Daily changes
  deltaRegistered  Float?
  deltaEligible    Float?
  deltaCombined    Float?
  
  // Percentage
  registeredPercent Float?
  
  // Metadata
  sourceUrl        String?
  rawHash          String?   // SHA-256 of downloaded file
  metaJson         String?   // JSON: {sheetName, headerMap, rowsParsed, warnings}
  rawDataPath      String?
  fetchedAt        DateTime @default(now()) @db.Timestamptz
  isValidated      Boolean  @default(false)
  hasAnomalies     Boolean  @default(false)
  
  // Relations
  warehouses       ComexWarehouse[]
  
  @@index([date])
  @@map("comex_stocks")
}

// Per-warehouse breakdown (optional detail)
model ComexWarehouse {
  id           String      @id @default(cuid())
  stockId      String
  stock        ComexStock  @relation(fields: [stockId], references: [id], onDelete: Cascade)
  
  warehouseName String     // Brinks, Loomis, etc.
  registered    Float
  eligible      Float
  
  // Daily movements
  deposits      Float?
  withdrawals   Float?
  adjustments   Float?
  
  @@map("comex_warehouses")
}

// SGE Shanghai Silver Benchmark Price
model SgePrice {
  id            String   @id @default(cuid())
  date          DateTime @unique @db.Date
  
  // Price in original currency (CNY/g)
  priceCnyPerGram Float
  
  // Converted to USD/oz
  priceUsdPerOz   Float
  
  // Metadata
  unit            String   @default("CNY/g")
  sourceUrl       String?
  fxRateUsed      Float?   // USD/CNY rate used for conversion
  metaJson        String?  // JSON: {source, fetchMethod, warnings}
  fetchedAt       DateTime @default(now()) @db.Timestamptz
  isValidated     Boolean  @default(false)
  
  @@index([date])
  @@map("sge_prices")
}

// FX Rates (USD/CNY)
model FxRate {
  id          String   @id @default(cuid())
  date        DateTime @unique
  
  usdCnyRate  Float
  source      String   @default("ECB")
  metaJson    String?  // JSON: {apiProvider, fallbackUsed}
  
  fetchedAt   DateTime @default(now()) @db.Timestamptz
  
  @@index([date])
  @@map("fx_rates")
}

// COMEX Reference Price (Spot or Near-month)
model ComexPrice {
  id            String   @id @default(cuid())
  marketDate    DateTime @unique @db.Date
  
  priceUsdPerOz Float
  contract      String   @default("Spot")
  
  sourceName    String?  // "metals-api", "metals.dev", "yahoo", "manual"
  sourceUrl     String?
  metaJson      String?  // JSON: {apiProvider, fallbackUsed}
  fetchedAt     DateTime @default(now()) @db.Timestamptz
  
  @@index([marketDate])
  @@map("comex_prices")
}

// Historical Metal Prices (for backfill & charts)
model MetalPrice {
  id            String   @id @default(cuid())
  date          DateTime @unique @db.Date
  
  // Silver spot price (main field for backfill)
  xagUsdClose   Float    @map("xag_usd_close")
  xagUsdOpen    Float?   @map("xag_usd_open")
  xagUsdHigh    Float?   @map("xag_usd_high")
  xagUsdLow     Float?   @map("xag_usd_low")
  
  volume        Float?
  
  // Source tracking
  source        String   @default("stooq")  // "stooq", "yahoo", "manual"
  sourceUrl     String?  @map("source_url")
  
  fetchedAt     DateTime @default(now()) @map("fetched_at") @db.Timestamptz
  
  @@index([date])
  @@map("metal_prices")
}

// Retail Prices (Händlerpreise für Premium-Vergleich)
model RetailPrice {
  id             String   @id @default(cuid())
  date           DateTime @db.Date
  
  provider       String   // "Degussa", "ProAurum", etc.
  product        String   // "1oz Maple Leaf", "1oz Philharmoniker", etc.
  
  priceEur       Float    @map("price_eur")  // Preis in EUR
  fineOz         Float    @default(1.0) @map("fine_oz")  // Feinunzen (meist 1.0)
  
  // Calculated fields
  impliedUsdOz   Float?   @map("implied_usd_oz")  // Umgerechnet in USD/oz
  premiumPercent Float?   @map("premium_percent")  // Premium vs Spot in %
  
  // Source tracking & verification
  source              String   @default("manual")  // "manual", "scraper", "api"
  sourceUrl           String?  @map("source_url")
  rawExcerpt          String?  @map("raw_excerpt")  // HTML/JSON snippet with price (max 2KB)
  verificationStatus  String   @default("UNVERIFIED") @map("verification_status")  // "VERIFIED", "UNVERIFIED", "FAILED"
  
  fetchedAt      DateTime @default(now()) @map("fetched_at") @db.Timestamptz
  
  @@unique([date, provider, product])
  @@index([date, provider])
  @@map("retail_prices")
}

// Calculated Daily Spreads
model DailySpread {
  id                String   @id @default(cuid())
  date              DateTime @unique @db.Date
  
  // Prices
  sgeUsdPerOz       Float
  comexUsdPerOz     Float
  
  // Spreads
  spreadUsdPerOz    Float
  spreadPercent     Float
  
  // COMEX stocks on this date
  registered        Float
  eligible          Float
  total             Float
  registeredPercent Float?
  
  dataQuality       String   @default("OK")  // 'OK', 'WARN', 'FAIL'
  notesJson         String?  // JSON: {missingData, anomalies, warnings}
  
  // Physical Stress Index
  psi               Float?   // Physical Stress Index = spread / registered_ratio
  psiStressLevel    String?  // 'EXTREME', 'HIGH', 'MODERATE', 'LOW'
  
  // Flags
  isExtreme         Boolean  @default(false)
  zScore            Float?
  
  createdAt         DateTime @default(now()) @db.Timestamptz
  
  @@index([date])
  @@map("daily_spreads")
}

// Data Fetch Log (for monitoring)
model FetchLog {
  id          String   @id @default(cuid())
  date        DateTime @db.Date
  source      String   // "COMEX", "SGE", "FX"
  
  status      String   // "success", "error", "partial"
  statusCode  Int?
  errorMsg    String?
  
  fetchedAt   DateTime @default(now()) @db.Timestamptz
  duration    Int?     // milliseconds
  
  @@index([date, source])
  @@map("fetch_logs")
}

// Alert Configuration
model AlertConfig {
  id                    String   @id @default(cuid())
  name                  String   @unique
  
  enabled               Boolean  @default(true)
  
  // Threshold values
  spreadThreshold       Float?
  registeredThreshold   Float?
  withdrawalThreshold   Float?
  
  // Notification channels
  emailEnabled          Boolean  @default(false)
  telegramEnabled       Boolean  @default(false)
  
  updatedAt             DateTime @updatedAt
  
  @@map("alert_configs")
}

// Alert History
model AlertHistory {
  id          String   @id @default(cuid())
  date        DateTime
  
  alertType   String   // "spread", "registered", "withdrawal"
  message     String
  value       Float
  threshold   Float
  
  notified    Boolean  @default(false)
  createdAt   DateTime @default(now())
  
  @@index([date, alertType])
  @@map("alert_history")
}

// Debug Events (comprehensive logging for troubleshooting)
model DebugEvent {
  id        String   @id @default(uuid())
  ts        DateTime @default(now()) @db.Timestamptz
  scope     String   // "refresh", "backfill", "ui", "api"
  source    String   // "fx", "sge", "comex", "retail", "metal", "db"
  level     String   // "info", "warn", "error"
  message   String
  meta      Json?
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  
  @@index([ts(sort: Desc)])
  @@index([scope, source])
  @@index([level])
  @@map("debug_events")
}
